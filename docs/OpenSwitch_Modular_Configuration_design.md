# OpenSwitch Modular Configuration Design

## Contents
-----------
   - [High level design of OpenSwitch Modular Configuration](#high-level-design-of-openswitch-modular-configuration)
   - [Participating Modules](#participating-modules)
       - [Kconfig System](#kconfig-system)
       - [Kconfig Files Layout](#kconfig-files-layout)
       - [Custom Scripts](#custom-scripts)
       - [OVSDB-Schema](#ovsdb-schema)
       - [CIT Framework](#cit-framework)
   - [Design choices](#design-choices)
       - [Mapping File](#mapping-file)
       - [Repo level Kconfig files](#repo-level-kconfig-files)
       - [menuconfig for platform selection](#menuconfig-for-platform-selection)
   - [References](#references)

## High level design of OpenSwitch Modular Configuration
--------------------------------------------------------
OpenSwitch Modular Configuration allows users to carry out build time
customization of OpenSwitch image. Features can be enabled/disabled and
parameters can be changed via the framework resulting in customized OpenSwitch
image.

To provide a bird's eye view, design of Modular Configuration framework can be
classified into four categories. Details are covered in following sections:

* Kconfig system which handles the configuration front-end providing a UI for
  user interaction
* A set of scripts running under Yocto build infrastructure which converts
  configuration options generated by Kconfig system into something Yocto can
  understand
* Enhancements to OpenSwitch schema which helps scripts to identify and prune
  schema entries related to disabled features
* Enhancements to CIT framework which helps to identify and exclude tests
  related to disabled features

```

    +--------------------+     +-------------+
    |    .ops-config     |     |             |
    | (default/generated +--+-->   Kconfig   |    +------------------+
    | from previous run) |  |  |   System    <----> User Interaction |
    +--------------------+  |  |             |    +------------------+
                            |  +------+------+
      +---------------+     |         |
      | Kconfig files +-----+         |
      +---------------+        +------v------+
                               | .ops-config |
                               |  (modified) |
                               +------+------+
                                      |
                                      |
                          +------------------------+
                          |           |            |
                          |     +-----v-----+      |    +------------+
                          |     |  Custom   |      |    | OpenSwitch |
                          |     |  python   <-----------+   Schema   |
                          |     |  scripts  |      |    +------------+
     +---------------+    |     +-----------+      |
     |    Enabled    |    |                        |
     | features and  <----+ OpenSwitch Yocto Build |
     | Manifest File |    |         System         |
     +-------+-------+    |                        |
             |            +-----------+------------+
             |                        |
             |                        |
      +------v------+     +-----------v------------+
      | OpenSwitch  |     |                        |
      | CIT System  +----->    OpenSwitch Image    |
      +-------------+     |                        |
                          +------------------------+

```

## Participating modules
------------------------

### Kconfig System
------------------
Kconfig front-end system is pulled into OpenSwitch Yocto build environment,
built and executed as part of a new make target "make menuconfig". Recipe
kconfig-frontends.bb is involved in this process. Since front-end is run on
the native/host system, native version of the recipe is used.

Kconfig system parses provided Kconfig files, works out all feature dependencies
and presents UI to the user. It generates a configuration file consisting of
enabled Kconfig symbols and parameter values (.ops-config) when user exits the
UI. Every time when UI is launched, saved set of user selected information is
picked up from existing .ops-config file.

.ops-config file is platform specific. This helps in preserving user choices
across platform selections. Symbolic links are used to facilitate this process.

### Kconfig files layout
------------------------
Kconfig files dictate the UI and dependencies between Kconfig Symbols. These
files follow standard kconfig language syntax. Following diagram shows how
Kconfig files are organized in OpenSwitch repository.

```
    +----------------------------------------------------------------------+
    |                        Root Kconfig file                             |
    |                                                                      |
    | * Located at $(BUILD_ROOT)/                                          |
    | * Fed to Kconfig System                                              |
    | * Imports build environment variables into Kconfig system            |
    +---------------------------------+------------------------------------+
                                      |
                                      |
    +---------------------------------v------------------------------------+
    |                  Platform specific Kconfig file                      |
    |                                                                      |
    | * Located at: $(BUILD_ROOT)/yocto/$(DISTRO)/meta-platform-$(DISTRO)- |
    |   $(CONFIGURED_PLATFORM)/                                            |
    | * Defines features and values specific to the platform               |
    | * "select" features applicable only to a subset of platforms. These  |
    |   shared features are defined elsewhere                              |
    +-------------------------+-----------------------------------+--------+
                              |                                   |
                              |                                   |
    +-------------------------v----------------------------+      |
    |         Vendor specific Kconfig files                |      |
    |                                                      |      |
    | * Located at $(BUILD_ROOT)/tools/kconfig/            |      |
    | * Defines features specific to a platform/forwarding |      |
    |   ASIC vendor                                        |      |
    +------------------------------------------------------+      |
                                                                  |
                                                                  |
    +-------------------------------------------------------------v--------+
    |                        Common Kconfig files                          |
    |                                                                      |
    | * These files define features that are visible across all platforms  |
    | * New files can be added on need basis                               |
    | * $(BUILD_ROOT)/yocto/openswitch/meta-distro-openswitch/recipes-ops/ |
    |   l2 defines L2 features                                             |
    | * $(BUILD_ROOT)/yocto/openswitch/meta-distro-openswitch/recipes-ops/ |
    |   l3 defines L3 and above features                                   |
    | * $(BUILD_ROOT)/yocto/openswitch/meta-distro-openswitch/recipes-ops/ |
    |   mgmt defines switch management related options                     |
    | * $(BUILD_ROOT)/yocto/openswitch/meta-distro-openswitch/recipes-ops/ |
    |   utils defines tools, utilities and troubleshooting options         |
    +----------------------------------------------------------------------+
```

### Custom Scripts
------------------
In OpenSwitch, each repository is represented by a bitbake recipe and creates
a package. A feature can either directly map to a repository or a repository
can host multiple sub-features. The cases where a feature has a one to one
mapping with a repository, feature enable/disable is controlled by including/
excluding the corresponding package. IMAGE_FEATURES and FEATURE_PACKAGES
options of Yocto are used for this purpose. Yocto further works out package
dependency tree and includes/excludes all dependent packages both external
and OpenSwitch specific. In cases where a repository hosts multiple
sub-features or if a key-value parameter has to be passed on, build flags are
passed to repository level make environment via recipe files.

The above tasks are handled by custom scripts that run inside OpenSwitch Yocto
build as part of "make" target.

### OVSDB-Schema
----------------
The schema is captured as part of the JSON format file (Ex: vswitch.extschema)
and the corresponding XML format file (Ex: vswitch.xml).
When certain features get disabled as part of OpenSwitch Modular Configuration,
the corresponding fields in the schema used by those features need to be pruned.
The fields used by the features are tagged with the feature (Kconfig symbol).
The fields that need to be pruned could be Table/Column/Enum (JSON Format) or
Table/Group/Column (XML Format).
The ops recipe has been modified to trigger the schema pruning scripts that will
take care of pruning the JSON & XML formats of the schema during "make".
Refer to the user-guide for the exact steps to follow while tagging the schema.

### CIT Framework
-----------------
The CIT framework deploys “pytest” to run the component/feature test-scripts.
As part of OpenSwitch Modular Configuration, when a certain feature is disabled,
the tests corresponding to it should not be run (as they’ll fail).
A file containing the list of enabled features will be generated as part of "make"
and will also be available as a manifest file along with the released/periodic builds.
These files will act as inputs to the test framework which will provide a mechanism
for every test-script to know what features have been enabled.
The test script needs to use pytest markers to skip certain tests.
Refer to the user-guide for the exact steps to follow while skipping the tests.

## Design choices
-----------------
Following alternates were considered during the design:

### Mapping file
----------------
A centralized file which carries Kconfig symbol to yocto package mapping,
Kconfig symbol to schema entry mapping and Kconfig symbol to test scripts
mapping can be kept. Following disadvantages with the scheme:

* Additional manual step, prone to errors
* Mapping file can grow large and difficult to maintain
* For schema, mapping file closely resembles schema file duplicating work

### Repo level Kconfig files
----------------------------
Instead of keeping all Kconfig files in ops-build, spread them across repos
essentially keeping one Kconfig file per repo/feature. Following disadvantages
with the scheme:

* Increased build system complexity and reduced speed
* Loss of UI flexibility
* Loss of readability - of both Kconfig file tree and feature tree
* Tricky to handle certain cases like common feature sets, multiple implementations
  of same feature

### menuconfig for platform selection
-------------------------------------
Instead of "make configure"/"make switch-platform", use "make menuconfig" to
select platform. Following disadvantages with the scheme:

* Each platform has its own configuration file. So to load a configuration file,
  platform should be known
* Interactive process, not script friendly
* menuconfig is supposed to be an optional step and for most of the time, default
  configuration file should take care of feature sets

## References
-------------
* [Kconfig Language Syntax](https://www.kernel.org/doc/Documentation/kbuild/kconfig-language.txt)
* [User Guide](http://git.openswitch.net/cgit/openswitch/ops/tree/docs/OpenSwitch_Modular_Configuration_user_guide.md?h=feature/ops_config)
* [IRC Discussion](http://eavesdrop.openswitch.net/irclogs/%23openswitch/%23openswitch.2015-11-11.log.html)
